source s_remote_syslog {
	tcp(ip(0.0.0.0) port(514) max-connections(256)
		tls(key_file("/etc/ssl/syslog-ng/machine.key")
			cert_file("/etc/ssl/syslog-ng/machine.crt")
			ca_dir("/etc/ssl/syslog-ng/ca.d")));
};


###########################
### standard facilities ###
###########################

<% %w(messages auth cron ftp kern mail debug error).each do |dest| %>
# <%= dest %>
destination d_archive_<%= dest %> {
	file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/<%= dest %>.log"
		suppress(<%= node[:syslog][:suppress] %>));
};

log {
	source(s_remote_syslog);
	source(s_local);
	filter(f_<%= dest %>);
	destination(d_archive_<%= dest %>);
};

<% end %>


####################################
### automatic log files by ident ###
####################################

# LOCAL1: per-host log with standard template
destination d_archive_auto_local1 {
	file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/local/$PROGRAM.log"
		suppress(<%= node[:syslog][:suppress] %>));
};

log {
	source(s_remote_syslog);
	filter(f_auto_local1);
	destination(d_archive_auto_local1);
};

# LOCAL2: combined log with standard template
destination d_archive_auto_local2 {
	file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/combined/$PROGRAM.log"
		suppress(<%= node[:syslog][:suppress] %>));
};

log {
	source(s_remote_syslog);
	filter(f_auto_local2);
	destination(d_archive_auto_local2);
};

# LOCAL3: per-host log without template
destination d_archive_auto_local3 {
	file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/local/$PROGRAM.log"
		template("$MSG\n")
		suppress(<%= node[:syslog][:suppress] %>));
};

log {
	source(s_remote_syslog);
	filter(f_auto_local3);
	destination(d_archive_auto_local3);
};

# LOCAL4: combined log without template
destination d_archive_auto_local4 {
	file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/combined/$PROGRAM.log"
	template("$MSG\n")
	suppress(<%= node[:syslog][:suppress] %>));
};

log {
	source(s_remote_syslog);
	filter(f_auto_local4);
	destination(d_archive_auto_local4);
};


#########################
### mongodb log files ###
#########################

filter f_mongodb { facility(local0) and program("mongodb"); };

destination d_archive_mongodb { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/mongodb/$PROGRAM.log" template("$MSG\n")); };

log { source(s_remote_syslog); filter(f_mongodb); destination(d_archive_mongodb); };


#######################
### mysql log files ###
#######################

filter f_mysql_error { facility(local0) and level(error) and program("mysql"); };
filter f_mysql_slow  { facility(local0) and level(notice) and program("mysql"); };

destination d_archive_mysql_error { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/mysql/mysqld.err" template("$MSG\n")); };
destination d_archive_mysql_slow  { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/mysql/slow-queries.log" template("$MSG\n")); };

log { source(s_remote_syslog); filter(f_mysql_error); destination(d_archive_mysql_error); };
log { source(s_remote_syslog); filter(f_mysql_slow); destination(d_archive_mysql_slow); };


#####################
### php log files ###
#####################

filter f_php_error { facility(local0) and level(error) and program("php"); };
filter f_php_fpm   { facility(local0) and level(notice) and program("php"); };
filter f_php_slow  { facility(local0) and level(info) and program("php"); };

destination d_archive_php_error { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/php-error.log" template("$MSG\n")); };
destination d_archive_php_fpm   { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/php-fpm.log" template("$MSG\n")); };
destination d_archive_php_slow  { file("<%= node[:syslog][:archivedir] %>/$YEAR/$MONTH/$DAY/$HOST/php-slow-request.log" template("$MSG\n")); };

log { source(s_remote_syslog); filter(f_php_error); destination(d_archive_php_error); };
log { source(s_remote_syslog); filter(f_php_fpm); destination(d_archive_php_fpm); };
log { source(s_remote_syslog); filter(f_php_slow); destination(d_archive_php_slow); };
