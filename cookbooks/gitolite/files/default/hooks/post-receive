#!/usr/bin/ruby -w

def config(key)
  %x(git config --get #{key.to_s} 2>/dev/null).chomp
end

def cleanup_stale
  age = config('cleanup.age').to_i
  return unless age > 0

  pattern = Regexp.new(config('cleanup.pattern'))
  branches = %x(git branch --list).split.map(&:chomp).select do |branch|
    branch =~ pattern
  end

  now = Time.now

  stale = branches.select do |branch|
    mtime = Time.at(%x(git --no-pager show -s --format=%at #{branch}).chomp.to_i)
    now - mtime > age*24*60*60
  end

  if stale.any?
    STDERR.puts
    STDERR.puts "The following branches had no activity for #{age} days and have been deleted:"
    STDERR.puts
    stale.each do |branch|
      rev = %x(git rev-parse #{branch}).chomp
      STDERR.puts " - #{branch} -> #{rev}"
      %x(git branch -D #{branch})
    end
    STDERR.puts
  end
end

STDIN.each_line do |line|
  rev_old, rev_new, ref = line.split(" ")

  cleanup_stale
end
